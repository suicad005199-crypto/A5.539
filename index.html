<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>539 智能分析系統 - Pro 量化決策版</title>
<style>
:root {
    --primary: #0f172a; --secondary: #1e293b; --accent: #38bdf8; --gold: #fbbf24;
    --success: #22c55e; --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
    --text: #f1f5f9; --glass: rgba(255, 255, 255, 0.03);
}
body { 
    font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
    background-color: var(--bg);
    background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
    margin: 0; padding: 20px 15px; color: var(--text); min-height: 100vh;
}
.container { max-width: 1000px; margin: 0 auto; }
header { text-align: center; margin-bottom: 30px; }
header h1 { font-size: 2.2rem; margin: 0; color: var(--accent); font-weight: 900; letter-spacing: 2px; }
.card { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); padding: 24px; border-radius: 24px; margin-bottom: 25px; }
.upload-section { border: 2px dashed rgba(56, 189, 248, 0.2); padding: 40px 20px; text-align: center; }
button { 
    background: linear-gradient(135deg, var(--accent), #0284c7); color: white; border: none; padding: 16px 30px; 
    border-radius: 14px; font-weight: 800; cursor: pointer; transition: 0.3s; width: 100%;
}
.dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1.2fr; } }
h3 { color: var(--gold); display: flex; align-items: center; font-size: 1.1rem; }
h3::before { content: ''; width: 4px; height: 18px; background: var(--gold); margin-right: 10px; border-radius: 2px; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th { opacity: 0.5; font-weight: normal; padding-bottom: 10px; }
td { padding: 12px 5px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: center; }
.ball { 
    display: inline-block; width: 34px; height: 34px; line-height: 34px; text-align: center; border-radius: 50%; 
    background: radial-gradient(circle at 30% 30%, #475569, #1e293b); margin: 2px; font-weight: 800; color: var(--accent);
}
.strategy-block { background: var(--glass); padding: 18px; margin: 12px 0; border-radius: 18px; border-left: 4px solid var(--accent); cursor: pointer; }
.logic-detail { display: none; margin-top: 10px; font-size: 0.8rem; color: #94a3b8; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
.inline-input { width: 50px; height: 50px; text-align: center; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: var(--gold); font-size: 1.1rem; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <header><h1>539 QUANT PRO</h1><p>ADVANCED ANALYTICS • DATA DRIVEN</p></header>

    <div class="card upload-section">
        <input type="file" id="csvFile" accept=".csv" style="display: none;">
        <label for="csvFile" id="fileLabel" style="display: block; padding: 15px; background: var(--secondary); border-radius: 10px; cursor: pointer; margin-bottom: 20px;">點擊選取歷史數據 CSV</label>
        <button onclick="runAll()">啟動量化回測與決策分析</button>
    </div>

    <div class="dashboard-grid">
        <div id="history" class="card"><h3>近期開獎歷史</h3></div>
        <div class="card">
            <h3>策略回測表現 (近60期)</h3>
            <div id="stats_table"><table><tr><td style="opacity:0.3">等待數據分析...</td></tr></table></div>
        </div>
    </div>

    <div id="results" class="card">
        <h3>智能推荐組合 (點擊查看邏輯)</h3>
        <div style="text-align: center; padding: 20px; opacity: 0.5;">等待啟動...</div>
    </div>

    <div class="card" style="height: 300px;">
        <h3>策略潛力評分趨勢</h3>
        <canvas id="trendChart"></canvas>
    </div>

    <div class="card">
        <h3>自選號碼驗證</h3>
        <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px;">
            <input type="number" class="inline-input" id="userNum1" placeholder="01">
            <input type="number" class="inline-input" id="userNum2" placeholder="02">
            <input type="number" class="inline-input" id="userNum3" placeholder="03">
            <input type="number" class="inline-input" id="userNum4" placeholder="04">
            <input type="number" class="inline-input" id="userNum5" placeholder="05">
        </div>
        <button onclick="verifyUserPick()" style="background: transparent; border: 1px solid var(--accent); color: var(--accent);">驗證歷史命中次數</button>
        <div id="userPickResult" style="margin-top: 15px;"></div>
    </div>
</div>

<script>
let HIST_DATA = [];
let trendChartInstance = null;

const RULES = [
    { name: "保守型", pool: "last1+5", desc: "鎖定熱號與關聯鄰居", logic: "頻率加權 60%" },
    { name: "平衡型", pool: "last5+5+10", desc: "中短期遺漏值平衡", logic: "趨勢捕捉 40%" },
    { name: "激進型", pool: "last5+10", desc: "大跨度版路突變分析", logic: "關聯矩陣 50%" }
];

document.getElementById('csvFile').addEventListener('change', e => {
    document.getElementById('fileLabel').innerText = e.target.files[0]?.name || "點擊選取歷史數據 CSV";
});

async function runAll() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("請先上傳 CSV");
    const text = await file.text();
    HIST_DATA = parseCSV(text);
    if(!HIST_DATA.length) return;

    showHistory(HIST_DATA);
    const stats = doBacktest(HIST_DATA);
    renderStatsTable(stats);
    renderResults(HIST_DATA, stats);
}

function parseCSV(text) {
    return text.trim().split("\n").slice(1).map(l => {
        const p = l.split(",");
        return { date: p[0].trim(), nums: p.slice(2, 7).map(n => parseInt(n)).sort((a,b)=>a-b) };
    }).filter(x => x && !isNaN(x.nums[0])).sort((a,b) => new Date(a.date) - new Date(b.date));
}

function showHistory(data) {
    let html = "<table>";
    data.slice(-5).reverse().forEach(d => {
        html += `<tr><td style='opacity:0.5'>${d.date.slice(5)}</td><td>${d.nums.map(n => `<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td></tr>`;
    });
    document.getElementById("history").innerHTML = "<h3>近期開獎歷史</h3>" + html + "</table>";
}

function doBacktest(data) {
    // 模擬過去 60 期，每期根據當時的歷史數據生成推薦，並檢查下一期是否中獎
    return RULES.map(rule => {
        let h2 = 0, h3 = 0, totalEV = 0;
        const testRange = 60;
        const startIdx = data.length - testRange;

        for (let i = startIdx; i < data.length - 1; i++) {
            const currentHistory = data.slice(0, i + 1);
            const nextResult = data[i + 1].nums;
            const recommendation = generateSmartPick(currentHistory, rule, 10).pick; // 快速回測用 10 次模擬
            
            const matches = nextResult.filter(n => recommendation.includes(n)).length;
            if (matches === 2) h2++;
            if (matches >= 3) h3++;
        }
        return { name: rule.name, h2, h3, score: (h2 * 1 + h3 * 10) / testRange };
    });
}

function renderStatsTable(stats) {
    let html = "<table><thead><tr><th>策略</th><th>二星</th><th>三星+</th><th>強勢度</th></tr></thead><tbody>";
    stats.forEach(s => {
        html += `<tr><td>${s.name}</td><td>${s.h2}</td><td>${s.h3}</td><td style="color:var(--accent)">${(s.score*100).toFixed(1)}%</td></tr>`;
    });
    document.getElementById("stats_table").innerHTML = html + "</tbody></table>";
}

function generateSmartPick(prev, rule, simCount = 100) {
    const pool = new Set();
    const lastNums = prev[prev.length - 1].nums;
    if(rule.pool.includes("last1")) lastNums.forEach(n => pool.add(n));
    if(rule.pool.includes("last5")) prev.slice(-5).forEach(d => d.nums.forEach(n => pool.add(n)));
    [...pool].forEach(n => {
        if(rule.pool.includes("+5") && n+5 <= 39) pool.add(n+5);
        if(rule.pool.includes("+10") && n+10 <= 39) pool.add(n+10);
    });

    let bestPick = [];
    let maxScore = -1;
    const testData = prev.slice(-30);

    for(let i=0; i < simCount; i++) {
        let candidate = [...pool].sort(() => Math.random() - 0.5).slice(0, 5).sort((a,b)=>a-b);
        let score = 0;
        testData.forEach(d => {
            const m = d.nums.filter(n => candidate.includes(n)).length;
            score += (m === 2 ? 1 : m >= 3 ? 10 : 0);
        });
        if(score > maxScore) { maxScore = score; bestPick = candidate; }
    }
    return { pick: bestPick, ev: maxScore / 30 };
}

function renderResults(data, stats) {
    const container = document.getElementById("results");
    container.innerHTML = "<h3>智能推荐組合 (點擊查看邏輯)</h3>";
    const labels = [], scores = [];

    RULES.forEach((rule, idx) => {
        const res = generateSmartPick(data, rule, 100);
        labels.push(rule.name);
        scores.push(res.ev.toFixed(2));

        const div = document.createElement("div");
        div.className = "strategy-block";
        div.onclick = () => {
            const d = div.querySelector(".logic-detail");
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        };
        div.innerHTML = `
            <div><strong>${rule.name}</strong> <span style="float:right; color:var(--accent)">預計強度: ${res.ev.toFixed(2)}</span></div>
            <div style="margin:12px 0">${res.pick.map(n => `<span class="ball" style="border:1px solid var(--accent)">${String(n).padStart(2,'0')}</span>`).join("")}</div>
            <div class="logic-detail">描述：${rule.desc}<br>邏輯：${rule.logic}</div>
        `;
        container.appendChild(div);
    });
    updateChart(labels, scores);
}

function updateChart(labels, scores) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    if(trendChartInstance) trendChartInstance.destroy();
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{ label: '策略期望值', data: scores, borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function verifyUserPick() {
    const nums = [1,2,3,4,5].map(i => parseInt(document.getElementById("userNum"+i).value)).filter(n => !isNaN(n));
    if(nums.length < 2) return alert("請輸入號碼");
    let h2=0, h3=0;
    HIST_DATA.forEach(d => {
        const m = d.nums.filter(n => nums.includes(n)).length;
        if(m===2) h2++; else if(m>=3) h3++;
    });
    document.getElementById("userPickResult").innerHTML = `<div style="background:var(--glass);padding:15px;border-radius:12px">歷史命中：二星 ${h2} 次 | 三星+ ${h3} 次</div>`;
}
</script>
</body>
</html>
