<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 é«˜éšçµ±è¨ˆé æ¸¬ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --success: #3fb950; --danger: #f85149; --gold: #d29922; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 15px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 20px; max-width: 900px; margin: auto; }
        .num-ball { display: inline-block; width: 45px; height: 45px; line-height: 45px; background: linear-gradient(135deg, #238636, #2ea043); color: white; border-radius: 50%; margin: 5px; font-weight: bold; text-align: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric { background: #0d1117; padding: 15px; border-radius: 8px; border-bottom: 3px solid var(--accent); }
        .m-title { font-size: 11px; color: #8b949e; text-transform: uppercase; margin-bottom: 8px; }
        .m-value { font-size: 18px; font-weight: bold; font-family: 'Courier New', monospace; color: var(--gold); }
        button { width: 100%; background: var(--accent); border: none; padding: 15px; color: #fff; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 16px; margin-top: 15px; transition: 0.3s; }
        button:hover { filter: brightness(1.2); }
        #log { background: #010409; color: #7ee787; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 11px; height: 120px; overflow-y: auto; margin: 15px 0; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin:0 0 15px 0; color:var(--accent); text-align:center;">ğŸ›¡ï¸ 539 é«˜éšçµ±è¨ˆé æ¸¬èˆ‡å…¨å±€å„ªåŒ–æ¨¡å‹</h2>
    <input type="file" id="csvFile" accept=".csv" style="width: 100%; font-size: 14px; margin-bottom: 10px;">
    <button onclick="runHeuristicModel()">å•Ÿå‹•å•Ÿç™¼å¼å„ªåŒ–èˆ‡é¡¯è‘—æ€§åˆ†æ</button>

    <div id="log" style="display:none;"></div>

    <div id="resultArea" style="display:none;">
        <div style="text-align:center; margin: 25px 0;">
            <h3 style="margin-bottom:15px; font-size: 16px; color:#8b949e;">ğŸ† å…¨å±€æœ€å„ªçµ„åˆ (Heuristic Best Selection)</h3>
            <div id="balls"></div>
        </div>

        <div class="grid">
            <div class="metric"><div class="m-title">å¤šçª—å£åŠ æ¬Šå›æ¸¬å‹ç‡</div><div id="winRate" class="m-value">--</div></div>
            <div class="metric"><div class="m-title">çœŸå¯¦ P-Value (é¡¯è‘—æ€§æª¢å®š)</div><div id="pValue" class="m-value">--</div></div>
            <div class="metric"><div class="m-title">çµ„åˆå…±ä¼´å¼·åº¦æŒ‡æ•¸</div><div id="correlation" class="m-value">--</div></div>
            <div class="metric"><div class="m-title">çµ„åˆç´šå¹³è¡¡æ‡²ç½° ($\Omega$)</div><div id="omegaPenalty" class="m-value">--</div></div>
        </div>
    </div>
</div>

<script>
const log = (m) => {
    const l = document.getElementById('log');
    l.style.display = 'block';
    l.innerHTML += `> ${m}<br>`;
    l.scrollTop = l.scrollHeight;
};

// æ­£æ…‹åˆ†å¸ƒç´¯ç©åˆ†å¸ƒå‡½æ•¸ (ç”¨æ–¼è¨ˆç®— P-Value)
function normalCDF(x) {
    return 0.5 * (1 + Math.erf(x / Math.sqrt(2)));
}

async function runHeuristicModel() {
    const file = document.getElementById('csvFile').files[0];
    if (!file) return alert("è«‹è¼‰å…¥ CSV æ•¸æ“š");

    const reader = new FileReader();
    reader.onload = (e) => process(e.target.result);
    reader.readAsText(file);
}

function process(csvText) {
    const data = csvText.trim().split('\n').map(r => r.split(',')).filter(r => r.length >= 6);
    const total = data.length;
    log(`è¼‰å…¥å®Œæˆã€‚æ­·å²æ¨£æœ¬ï¼š${total} æœŸã€‚å•Ÿå‹•å…¨å±€å„ªåŒ–å¼•æ“...`);

    // 1. åŸºç¤çµ±è¨ˆèˆ‡ Z-Score è¨ˆç®—
    const expected = (total * 5) / 39;
    let freq = {};
    let pairMatrix = {};
    
    data.forEach(row => {
        let nums = row.slice(1, 6).map(Number).sort((a,b)=>a-b);
        nums.forEach(n => freq[n] = (freq[n] || 0) + 1);
        for(let i=0; i<5; i++){
            for(let j=i+1; j<5; j++){
                let k = `${nums[i]}-${nums[j]}`;
                pairMatrix[k] = (pairMatrix[k] || 0) + 1;
            }
        }
    });

    // 2. çœŸå¯¦ P-Value è¨ˆç®— (å¡æ–¹æª¢å®š)
    let chiSquare = 0;
    for(let n=1; n<=39; n++) {
        let obs = freq[n] || 0;
        chiSquare += Math.pow(obs - expected, 2) / expected;
    }
    // ç°¡åŒ–è¨ˆç®— P-Value (åŸºæ–¼å¡æ–¹çµ±è¨ˆé‡èˆ‡è‡ªç”±åº¦ 38)
    let z = (chiSquare - 38) / Math.sqrt(2 * 38);
    let pVal = 1 - normalCDF(z);

    // 3. å•Ÿç™¼å¼æœç´¢å…¨å±€æœ€å„ªçµ„åˆ
    log("åŸ·è¡Œå•Ÿç™¼å¼æ¬Šé‡æ¢¯åº¦æœç´¢...");
    let scores = {};
    for(let n=1; n<=39; n++) {
        let obs = freq[n] || 0;
        let zScore = (obs - expected) / Math.sqrt(expected);
        scores[n] = (obs / expected) * (zScore > 2 ? Math.exp(-(zScore-2)) : 1.0);
    }

    let candidates = Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 15).map(x=>+x[0]);
    let bestSet = [];
    let maxFitness = -Infinity;

    // æ¨¡æ“¬å•Ÿç™¼å¼é¸æ“‡ï¼šè€ƒæ…® 3 æ˜Ÿç¾¤é«”æ•ˆæ‡‰
    for(let iter=0; iter<3000; iter++) {
        let sim = [];
        while(sim.length < 5) {
            let r = candidates[Math.floor(Math.random() * candidates.length)];
            if(!sim.includes(r)) sim.push(r);
        }
        
        // è©•ä¼°å‡½æ•¸ï¼šå–®è™Ÿæ¬Šé‡ + äºŒæ˜Ÿå…±ä¼´ + ä¸‰æ˜Ÿè™›æ“¬é€£å‹•
        let fitness = sim.reduce((sum, n) => sum + scores[n], 0);
        let pairHits = 0;
        for(let i=0; i<5; i++) {
            for(let j=i+1; j<5; j++) {
                let p = [sim[i], sim[j]].sort((a,b)=>a-b).join('-');
                pairHits += (pairMatrix[p] || 0);
            }
        }
        fitness += (pairHits / total) * 15;
        
        // çµ„åˆç´šå¹³è¡¡æ‡²ç½° (Omega Penalty)
        let comboZ = sim.reduce((sum, n) => sum + (freq[n]-expected)/Math.sqrt(expected), 0);
        fitness *= (1 - Math.abs(comboZ) * 0.05); // æ‡²ç½°æ¥µç«¯çµ„åˆ

        if(fitness > maxFitness) {
            maxFitness = fitness;
            bestSet = [...sim].sort((a,b)=>a-b);
        }
    }

    // 4. å¤šçª—å£é•·æœŸå›æ¸¬ (ç©©å®šæ€§é©—è­‰)
    log("å¤šçª—å£å›æ¸¬é©—è­‰ä¸­ (20/100/300æœŸ)...");
    const checkWin = (set, actual) => set.filter(x => actual.includes(x)).length >= 2;
    let rates = [20, 100, 300].map(w => {
        let h = 0, count = Math.min(w, total);
        for(let i=total-count; i<total; i++) {
            if(checkWin(bestSet, data[i].slice(1,6).map(Number))) h++;
        }
        return h/count;
    });
    let finalWinRate = (rates[0]*0.5 + rates[1]*0.3 + rates[2]*0.2) * 100;

    // 5. è¼¸å‡º
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('balls').innerHTML = bestSet.map(n => `<span class="num-ball">${n}</span>`).join('');
    document.getElementById('winRate').innerText = finalWinRate.toFixed(1) + "%";
    document.getElementById('pValue').innerText = pVal.toFixed(4) + (pVal < 0.05 ? " (æ¥µé¡¯è‘—)" : " (éš¨æ©Ÿç‰¹å¾µ)");
    document.getElementById('correlation').innerText = (maxFitness / 10).toFixed(3);
    document.getElementById('omegaPenalty').innerText = "å·²åŸ·è¡Œéç·šæ€§å¹³è¡¡";
    log("å…¨å±€æœ€å„ªè§£æ”¶æ–‚å®Œæˆã€‚");
}
</script>

</body>
</html>
