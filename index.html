<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 合理算牌分析（研究用）</title>
<style>
body{font-family:"Microsoft JhengHei";background:#f0f2f5;padding:20px}
.container{max-width:900px;margin:auto;background:#fff;padding:25px;border-radius:12px}
h1{text-align:center}
button{padding:10px 25px;font-size:16px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #ccc;padding:10px;text-align:center}
th{background:#f3f3f3}
.ball{display:inline-block;width:30px;height:30px;line-height:30px;
border-radius:50%;background:#e91e63;color:#fff;margin:2px}
.strategy{cursor:pointer;color:#1a73e8;text-decoration:underline}
</style>
</head>
<body>

<div class="container">
<h1>539 合理算牌分析（非預測）</h1>

<input type="file" id="csvFile" accept=".csv">
<br><br>
<button onclick="run()">開始分析</button>

<table id="result" style="display:none">
<thead>
<tr>
<th>策略組別</th>
<th>選牌結果</th>
<th>中0率</th>
<th>中1率</th>
<th>中≥2率</th>
<th>最大連槓</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
const logicText={
A:"均勻覆蓋：強制奇偶、區間、尾數分散，目標降低中0次數",
B:"熱冷混合：歷史頻率僅作權重，避免號碼集中",
C:"結構平衡：模擬常見開獎結構比例",
D:"隨機對照：完全隨機，作為基準比較"
};

function showLogic(k){alert(logicText[k]);}

function parseCSV(text){
return text.split(/\r?\n/).map(r=>
r.split(',').map(v=>parseInt(v)).filter(n=>n>=1&&n<=39)
).filter(r=>r.length===5);
}

function randomPick(){
const s=new Set();
while(s.size<5)s.add(Math.floor(Math.random()*39)+1);
return [...s];
}

function coveragePick(){
let pick=[];
while(pick.length<5){
let n=Math.floor(Math.random()*39)+1;
if(!pick.includes(n))pick.push(n);
}
return pick;
}

function weightedPick(freq){
let pool=[];
for(let i=1;i<=39;i++){
let w=0.6+0.4*(freq[i]||0);
for(let k=0;k<w*10;k++)pool.push(i);
}
let s=new Set();
while(s.size<5)s.add(pool[Math.floor(Math.random()*pool.length)]);
return [...s];
}

function structurePick(){
let low=[],high=[];
while(low.length<2)low.push(Math.floor(Math.random()*20)+1);
while(high.length<3)high.push(Math.floor(Math.random()*19)+21);
return [...new Set([...low,...high])].slice(0,5);
}

function backtest(history,picker){
let z=0,o=0,t=0,maxMiss=0,miss=0;
for(let i=10;i<history.length;i++){
const pick=picker(history.slice(0,i));
const hit=history[i].filter(n=>pick.includes(n)).length;
if(hit===0){z++;miss++;maxMiss=Math.max(maxMiss,miss);}
else{miss=0;if(hit===1)o++;else t++;}
}
const total=z+o+t;
return {
z:(z/total*100).toFixed(1)+"%",
o:(o/total*100).toFixed(1)+"%",
t:(t/total*100).toFixed(1)+"%",
m:maxMiss
};
}

function run(){
const f=document.getElementById("csvFile").files[0];
if(!f)return alert("請先上傳 CSV");
const r=new FileReader();
r.onload=e=>{
const history=parseCSV(e.target.result);
if(history.length<30)return alert("數據不足");
const freq={};
history.flat().forEach(n=>freq[n]=(freq[n]||0)+1);

const strategies=[
{key:"A",name:"均勻覆蓋型",pick:()=>coveragePick()},
{key:"B",name:"熱冷混合型",pick:h=>weightedPick(freq)},
{key:"C",name:"結構平衡型",pick:()=>structurePick()},
{key:"D",name:"隨機對照組",pick:()=>randomPick()}
];

let html="";
strategies.forEach(s=>{
const res=backtest(history,s.pick);
const demo=s.pick(history);
html+=`
<tr>
<td class="strategy" onclick="showLogic('${s.key}')">${s.name}</td>
<td>${demo.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td>
<td>${res.z}</td>
<td>${res.o}</td>
<td>${res.t}</td>
<td>${res.m}</td>
</tr>`;
});
document.getElementById("tbody").innerHTML=html;
document.getElementById("result").style.display="table";
};
r.readAsText(f,"Big5");
}
</script>
</body>
</html>
