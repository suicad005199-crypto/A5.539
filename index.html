<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV æ•¸æ“šå›æ¸¬åˆ†æç³»çµ±</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; width: 100%; max-width: 1200px; margin: 0 auto 20px; box-sizing: border-box; }
        .panel-title { margin-top: 0; color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; font-size: 1.1rem; margin-bottom: 15px; }
        
        /* å¸ƒå±€æ§åˆ¶ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-top: 4px solid var(--primary); }
        .num-badge { display: inline-block; background: var(--primary); color: white; border-radius: 4px; padding: 2px 8px; margin: 2px; font-weight: bold; font-size: 0.9rem; }
        .hit-badge { background: var(--success) !important; }

        /* è¡¨æ ¼èˆ‡åœ–è¡¨ */
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; background: white; }
        th, td { border: 1px solid #eee; text-align: center; padding: 8px; font-size: 13px; }
        th { background: var(--primary); color: white; }
        .dot { background: var(--accent); color: white; border-radius: 50%; display: inline-block; width: 20px; height: 20px; line-height: 20px; }

        /* å›æ¸¬é¢æ¿å°ˆç”¨ */
        .backtest-row { background: #fff; }
        .hit-count { font-weight: bold; color: var(--success); }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin: 2px; background: #dfe6e9; }
        
        /* æ”¶åˆ */
        .accordion-header { cursor: pointer; background: #eee; padding: 10px; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        .accordion-content { display: none; padding: 15px; line-height: 1.6; font-size: 14px; }
    </style>
</head>
<body>

    <div class="panel">
        <h3 class="panel-title">1. æ•¸æ“šä¸Šå‚³èˆ‡ç‹€æ…‹</h3>
        <input type="file" id="csvFile" accept=".csv">
        <div id="statusTracker" style="margin-top:15px"></div>
    </div>

    <div id="analysisSection" style="display:none;">
        <div class="panel">
            <h3 class="panel-title">2. æ™ºèƒ½é æ¸¬ (ä¸‹ä¸€æœŸ)</h3>
            <div class="grid-container" id="predictionResults"></div>
        </div>

        <div class="panel">
            <h3 class="panel-title">3. é€£è™Ÿåˆ†å¸ƒåœ– (æœ€æ–° 10 æœŸ)</h3>
            <div class="table-container">
                <table id="distributionTable"><thead><tr id="chartHeader"></tr></thead><tbody id="chartBody"></tbody></table>
            </div>
        </div>

        <div class="panel">
            <h3 class="panel-title">4. æ»¾å‹•å›æ¸¬ç´€éŒ„ (å‰ 10 æœŸé©—è­‰)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>ç•¶æœŸé–‹çè™Ÿç¢¼</th><th>é æ¸¬çµ„ (å›ºå®šç­–ç•¥)</th><th>å‘½ä¸­æ•¸</th></tr>
                    </thead>
                    <tbody id="backtestBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="accordion-header" onclick="toggleAccordion()">ç­–ç•¥é‚è¼¯èˆ‡å›æ¸¬èªªæ˜ (é»æ“Šå±•é–‹)</div>
        <div id="accContent" class="accordion-content">
            <strong>â— æ»¾å‹•å›æ¸¬é‚è¼¯ï¼š</strong> ç³»çµ±æœƒå›åˆ°éå» 10 æœŸçš„æ™‚é–“é»ï¼Œå‡è¨­ç•¶æ™‚å°šæœªé–‹çï¼Œåˆ©ç”¨ã€Œé‚£ä¹‹å‰çš„æ­·å²è³‡æ–™ã€é€²è¡Œé æ¸¬ï¼Œå†èˆ‡å¯¦éš›é–‹ççµæœå°æ¯”ã€‚é€™æœ€èƒ½åæ˜ ç­–ç•¥çš„å¯¦æˆ°åƒ¹å€¼ã€‚<br>
            <strong>â— å‘½ä¸­å®šç¾©ï¼š</strong> é æ¸¬çš„ 5 å€‹è™Ÿç¢¼ä¸­ï¼Œå‡ºç¾åœ¨ç•¶æœŸé–‹ççµæœä¸­çš„æ•¸é‡ã€‚
        </div>
    </div>

    <script>
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => processData(e.target.result);
            reader.readAsText(file);
        });

        function processData(csvText) {
            const rows = csvText.split('\n').map(r => r.split(',')).filter(r => r.length > 1 && r[0].trim());
            renderChart(rows.slice(-10).reverse());
            renderStatusTracker(rows);
            runBacktest(rows);
            generateLatestPrediction(rows);
            document.getElementById('analysisSection').style.display = 'block';
        }

        // æ ¸å¿ƒæ¼”ç®—æ³•ï¼šæ ¹æ“šçµ¦å®šçš„æ­·å²è³‡æ–™ç”Ÿæˆ 5 å€‹é æ¸¬è™Ÿç¢¼
        function getPrediction(historyRows) {
            const allNums = historyRows.flatMap(r => r.slice(1)).map(n => n.trim());
            const freq = {};
            allNums.forEach(n => freq[n] = (freq[n] || 0) + 1);
            
            // ç­–ç•¥ï¼šæŒ‘é¸ 2 å€‹ç†±é–€ã€2 å€‹å†·é–€ã€1 å€‹ä¸Šä¸€æœŸé„°è¿‘è™Ÿ
            const sortedByFreq = Object.keys(freq).sort((a,b) => freq[b] - freq[a]);
            const hot = sortedByFreq.slice(0, 2);
            const cold = sortedByFreq.slice(-10).sort(() => 0.5 - Math.random()).slice(0, 2);
            
            const lastRow = historyRows[historyRows.length - 1].slice(1).map(n => parseInt(n));
            const neighbor = [(lastRow[0] + 1).toString()].filter(n => parseInt(n) <= 39);

            return [...new Set([...hot, ...cold, ...neighbor])].slice(0, 5);
        }

        function runBacktest(allRows) {
            const tbody = document.getElementById('backtestBody');
            tbody.innerHTML = '';
            
            // æ»¾å‹•å›æ¸¬æœ€è¿‘ 10 æœŸ
            for (let i = allRows.length - 1; i >= Math.max(0, allRows.length - 10); i--) {
                const currentDate = allRows[i][0];
                const actualNums = allRows[i].slice(1).map(n => n.trim());
                
                // é æ¸¬ç”¨çš„è³‡æ–™æ˜¯ç•¶å‰æ—¥æœŸä¹‹å‰çš„å…¨éƒ¨è³‡æ–™
                const historyBefore = allRows.slice(0, i);
                if (historyBefore.length === 0) continue;

                const predicted = getPrediction(historyBefore);
                const hits = predicted.filter(n => actualNums.includes(n));

                const tr = document.createElement('tr');
                tr.className = 'backtest-row';
                tr.innerHTML = `
                    <td>${currentDate}</td>
                    <td>${actualNums.join(', ')}</td>
                    <td>${predicted.map(n => `<span class="num-badge ${actualNums.includes(n) ? 'hit-badge' : ''}">${n}</span>`).join('')}</td>
                    <td class="hit-count">${hits.length}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function renderChart(data) {
            const header = document.getElementById('chartHeader');
            const body = document.getElementById('chartBody');
            header.innerHTML = '<th>æ—¥æœŸ</th>' + Array.from({length: 39}, (_, i) => `<th>${i+1}</th>`).join('');
            body.innerHTML = data.map(row => {
                const nums = row.slice(1).map(n => n.trim());
                let td = `<td>${row[0]}</td>`;
                for (let i = 1; i <= 39; i++) td += `<td>${nums.includes(i.toString()) ? '<span class="dot">'+i+'</span>' : ''}</td>`;
                return `<tr>${td}</tr>`;
            }).join('');
        }

        function renderStatusTracker(allRows) {
            const tracker = document.getElementById('statusTracker');
            const lastRow = allRows[allRows.length - 1].slice(1).map(n => n.trim());
            tracker.innerHTML = '';
            for (let i = 1; i <= 39; i++) {
                const numStr = i.toString();
                let count = 0;
                const isPresent = lastRow.includes(numStr);
                for (let j = allRows.length - 1; j >= 0; j--) {
                    if (allRows[j].slice(1).map(n => n.trim()).includes(numStr) === isPresent) count++; else break;
                }
                const color = isPresent ? '#ffeaa7' : '#dfe6e9';
                const textColor = isPresent ? '#d35400' : '#636e72';
                tracker.innerHTML += `<span class="status-tag" style="background:${color}; color:${textColor}">${i}:${isPresent?'é€£':'æœª'}${count}</span>`;
            }
        }

        function generateLatestPrediction(allRows) {
            const res = document.getElementById('predictionResults');
            const p = getPrediction(allRows);
            res.innerHTML = `
                <div class="card"><h4>ğŸ¯ ä¸‹æœŸå»ºè­°çµ„åˆ</h4>${p.map(n => `<span class="num-badge" style="font-size:1.2rem; padding:5px 15px;">${n}</span>`).join('')}</div>
                <div class="card"><h4>ğŸ’¡ æç¤º</h4>å›æ¸¬é¡¯ç¤ºè¿‘æœŸå‘½ä¸­ç‡æ³¢å‹•ï¼Œå»ºè­°åƒè€ƒä¸Šæ–¹é€£è™Ÿåˆ†å¸ƒåœ–é€²è¡Œæ‰‹å‹•å¾®èª¿ã€‚</div>
            `;
        }

        function toggleAccordion() {
            const c = document.getElementById('accContent');
            c.style.display = c.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>
</html>
