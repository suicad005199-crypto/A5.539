<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI å€é–“äº’è£œç³»çµ± - å„ªåŒ– v13</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; max-width: 1200px; margin: 0 auto; }
        .panel-title { margin: 0 0 15px 0; color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; font-size: 1.1rem; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-top: 4px solid var(--primary); }
        .num-badge { display: inline-block; background: var(--primary); color: white; border-radius: 4px; padding: 4px 12px; margin: 2px; font-weight: bold; }
        .hit-badge { background: var(--success) !important; box-shadow: 0 0 5px var(--success); }

        .table-container { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; background: white; }
        th, td { border: 1px solid #eee; text-align: center; padding: 10px 5px; font-size: 13px; }
        th { background: var(--primary); color: white; }
        
        .good-hit { background-color: #e8f5e9 !important; border: 2px solid var(--success) !important; }
        .hit-count { font-weight: bold; color: var(--success); font-size: 1.3rem; }

        .accordion-header { cursor: pointer; background: #eee; padding: 12px; border-radius: 6px; font-weight: bold; text-align: center; margin-top: 10px; }
        .accordion-content { display: none; padding: 20px; line-height: 1.8; background: #fff; border: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

    <div class="panel">
        <h3 class="panel-title">1. æ•¸æ“šè§£æ (v13 å€é–“äº’è£œç‰ˆ)</h3>
        <input type="file" id="csvFile" accept=".csv">
        <div id="statusTracker" style="margin-top:15px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
    </div>

    <div id="analysisSection" style="display:none;">
        <div class="panel">
            <h3 class="panel-title">2. AI å€é–“äº’è£œé æ¸¬ (ä¸‹ä¸€æœŸå»ºè­°)</h3>
            <div class="grid-container" id="predictionResults"></div>
        </div>

        <div class="panel">
            <h3 class="panel-title">3. æ»¾å‹•å›æ¸¬ç´€éŒ„ (10æœŸæ¸¬è©¦å€)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>çœŸå¯¦çè™Ÿ</th><th>é æ¸¬çµ„åˆ (å€é–“ç­–ç•¥)</th><th>å‘½ä¸­æ•¸</th></tr>
                    </thead>
                    <tbody id="backtestBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="accordion-header" onclick="toggleAccordion()">ğŸ’¡ v13 ç­–ç•¥æ ¸å¿ƒé‚è¼¯</div>
        <div id="accContent" class="accordion-content">
            <strong>1. å€é–“æ¬Šé‡åˆ†é… (1-2-2)ï¼š</strong><br>
            ç³»çµ±å°‡ 01-39 åˆ†ç‚º [1-13], [14-26], [27-39] ä¸‰å€ã€‚ç‚ºé¿å…è™Ÿç¢¼éåº¦é›†ä¸­ï¼Œå¼·åˆ¶è·¨å€é¸è™Ÿï¼Œç¢ºä¿åŸºæœ¬è¦†è“‹ç‡ã€‚<br>
            <strong>2. é„°è™Ÿäº’è£œ (Neighbor Hook)ï¼š</strong><br>
            ç³»çµ±æœƒæƒæ Top 10 çš„é«˜åˆ†è™Ÿç¢¼ï¼Œè‹¥ç™¼ç¾å…©è™Ÿç›¸é„°ï¼ˆå¦‚ 10, 11ï¼‰ï¼Œå‰‡çµ¦äºˆé¡å¤–åŠ åˆ†ï¼Œå¢åŠ ã€Œé›†å½ˆã€æ©Ÿæœƒã€‚<br>
            <strong>3. é›™å±¤éºæ¼åŠ æ¬Šï¼š</strong><br>
            å„ªå…ˆæ•æ‰éºæ¼ 3-5 æœŸï¼ˆå¼·å‹¢å›è£œï¼‰èˆ‡ 12 æœŸä»¥ä¸Šï¼ˆæ¥µå†·è½‰ç†±ï¼‰çš„è™Ÿç¢¼ï¼Œé¿é–‹ä¸­é–“å¹³æ·¡æœŸã€‚
        </div>
    </div>

    <script>
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            const data = [];
            lines.forEach((line, index) => {
                const cols = line.split(',').map(s => s.trim());
                if (index === 0 && isNaN(cols[1])) return;
                if (cols.length >= 6 && cols[0] !== "") {
                    data.push({ date: cols[0], nums: cols.slice(1, 6).map(Number).sort((a,b) => a-b) });
                }
            });
            if (data.length > 0) processSystem(data);
        }

        function processSystem(data) {
            runBacktest(data);
            generateNext(data);
            document.getElementById('analysisSection').style.display = 'block';
        }

        function getZonalPick(history) {
            const scores = Array(40).fill(0);
            const lastNums = history[history.length - 1].nums;
            
            for (let i = 1; i <= 39; i++) {
                let miss = 0;
                for (let j = history.length - 1; j >= 0; j--) {
                    if (!history[j].nums.includes(i)) miss++; else break;
                }

                // æ¬Šé‡ 1: éºæ¼åˆ†å±¤ (3-5æœŸ/12æœŸ+)
                if (miss >= 3 && miss <= 5) scores[i] += 120;
                else if (miss >= 12) scores[i] += 80;
                else if (miss >= 1 && miss <= 2) scores[i] += 40;

                // æ¬Šé‡ 2: é„°è™Ÿä¿‚æ•¸ (ä¸ŠæœŸè™Ÿç¢¼å‘¨åœ)
                if (lastNums.some(n => Math.abs(n - i) === 1)) scores[i] += 60;
            }

            // åˆ†å€é¸è™Ÿ
            const z1 = [], z2 = [], z3 = [];
            for (let i = 1; i <= 39; i++) {
                const obj = { n: i, s: scores[i] };
                if (i <= 13) z1.push(obj);
                else if (i <= 26) z2.push(obj);
                else z3.push(obj);
            }

            const sortFn = (a, b) => b.s - a.s;
            z1.sort(sortFn); z2.sort(sortFn); z3.sort(sortFn);

            // ç­–ç•¥ï¼šå¾ä¸‰å€åˆ†åˆ¥æŒ‘é¸ï¼Œæ¯”ä¾‹ç‚º 1:2:2 æˆ– 2:2:1 (å‹•æ…‹èª¿æ•´)
            let final = [];
            // æ¯å€å…ˆä¿åº•æ‹¿ 1 å€‹æœ€é«˜åˆ†
            final.push(z1[0].n, z2[0].n, z3[0].n);
            
            // å‰©ä¸‹ 2 å€‹å¾å…¨åŸŸæœ€é«˜åˆ†é¸å– (ä¸é‡è¤‡)
            const allSorted = [...z1, ...z2, ...z3].sort(sortFn);
            for (let item of allSorted) {
                if (final.length >= 5) break;
                if (!final.includes(item.n)) final.push(item.n);
            }

            return final.sort((a, b) => a - b);
        }

        function runBacktest(allData) {
            const tbody = document.getElementById('backtestBody');
            tbody.innerHTML = '';
            const startIdx = allData.length - 1;

            for (let i = startIdx; i > startIdx - 10 && i >= 0; i--) {
                const historyBefore = allData.slice(0, i);
                const actual = allData[i].nums;
                const pred = getZonalPick(historyBefore);
                const hits = pred.filter(n => actual.includes(n));

                const tr = document.createElement('tr');
                if (hits.length >= 2) tr.className = 'good-hit';
                tr.innerHTML = `
                    <td>${allData[i].date}</td>
                    <td>${actual.join(', ')}</td>
                    <td>${pred.map(n => `<span class="num-badge ${actual.includes(n) ? 'hit-badge' : ''}">${n}</span>`).join('')}</td>
                    <td class="hit-count">${hits.length}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function generateNext(allData) {
            const res = document.getElementById('predictionResults');
            const p = getZonalPick(allData);
            res.innerHTML = `<div class="card"><h4>ğŸ¯ AI å€é–“äº’è£œæ¨è–¦çµ„åˆ</h4>${p.map(n => `<span class="num-badge" style="font-size:1.2rem; padding:5px 15px;">${n}</span>`).join('')}</div>`;
        }

        function toggleAccordion() {
            const c = document.getElementById('accContent');
            c.style.display = (c.style.display === 'block') ? 'none' : 'block';
        }
    </script>
</body>
</html>
