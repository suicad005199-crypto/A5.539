<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>539 æ™ºèƒ½åˆ†æç³»çµ± - Pro é‡åŒ–æ±ºç­–ç‰ˆ</title>
<style>
:root {
    --primary: #0f172a; --secondary: #1e293b; --accent: #38bdf8; --gold: #fbbf24;
    --success: #22c55e; --error: #ef4444; --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
    --text: #f1f5f9; --glass: rgba(255, 255, 255, 0.03);
}

body { 
    font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
    background-color: var(--bg);
    background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
    margin: 0; padding: 20px 15px; color: var(--text);
    min-height: 100vh; line-height: 1.6;
}

.container { max-width: 1000px; margin: 0 auto; }

header { text-align: center; margin-bottom: 30px; padding: 10px 0; }
header h1 { 
    font-size: 2.2rem; margin: 0; color: var(--accent); font-weight: 900; 
    text-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
    letter-spacing: 2px;
}
header p { font-size: 0.85rem; margin: 8px 0 0; opacity: 0.5; letter-spacing: 3px; font-weight: 300; }

.card { 
    background: var(--card-bg); backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 24px; border-radius: 24px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    margin-bottom: 25px;
}

.upload-section { border: 2px dashed rgba(56, 189, 248, 0.2); transition: 0.3s; padding: 40px 20px; text-align: center; }
.upload-section:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.05); }

button { 
    background: linear-gradient(135deg, var(--accent), #0284c7);
    color: white; border: none; padding: 16px 30px; 
    border-radius: 14px; font-weight: 800; font-size: 1.1rem;
    cursor: pointer; transition: 0.3s;
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
    width: 100%; letter-spacing: 1px;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(56, 189, 248, 0.5); }

.dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }

h3 { font-size: 1.2rem; margin-top: 0; margin-bottom: 20px; color: var(--gold); display: flex; align-items: center; font-weight: 700; }
h3::before { content: ''; display: inline-block; width: 4px; height: 20px; background: var(--gold); margin-right: 12px; border-radius: 2px; }

table { width: 100%; border-collapse: collapse; }
th { text-align: center; font-size: 0.75rem; opacity: 0.4; padding: 12px; font-weight: normal; }
td { padding: 15px 5px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: center; }

.ball { 
    display: inline-block; width: 38px; height: 38px; line-height: 38px; 
    text-align: center; border-radius: 50%; 
    background: radial-gradient(circle at 30% 30%, #475569, #1e293b);
    margin: 4px; font-weight: 800; 
    font-size: 16px; color: var(--accent);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.resonance-card {
    background: linear-gradient(145deg, rgba(56, 189, 248, 0.1), rgba(0, 0, 0, 0.3));
    border: 1px solid var(--accent);
    animation: glow 2s infinite alternate;
}
@keyframes glow { from { box-shadow: 0 0 10px rgba(56, 189, 248, 0.1); } to { box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); } }

.strategy-block { 
    background: var(--glass); padding: 20px; margin: 15px 0; border-radius: 18px;
    border-left: 4px solid rgba(255,255,255,0.1); transition: 0.4s; cursor: pointer;
}
.strategy-block.active { border-left-color: var(--success); }

.logic-detail { display: none; margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; font-size: 0.85rem; color: #cbd5e1; }

.rate-badge { font-size: 0.7rem; padding: 5px 12px; border-radius: 20px; background: rgba(56, 189, 248, 0.15); color: var(--accent); font-weight: bold; }

.inline-input { 
    width: 60px; height: 60px; text-align: center; margin: 0 5px; 
    border: 2px solid rgba(255,255,255,0.1); border-radius: 16px; 
    font-size: 1.4rem; font-weight: 900; background: #0f172a; color: var(--gold);
}
.cold-tag { background: rgba(239, 68, 68, 0.15); color: var(--error); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <header><h1>539 QUANT PRO</h1><p>CONVERGENCE ANALYSIS â€¢ 500 SIMS</p></header>

    <div class="card upload-section">
        <h3 style="justify-content: center; color: var(--accent);">æ•¸æ“šçµ‚ç«¯å…¥å£</h3>
        <input type="file" id="csvFile" accept=".csv" style="display: none;">
        <label for="csvFile" id="fileLabel" style="display: block; padding: 15px; background: var(--secondary); border-radius: 10px; cursor: pointer; margin-bottom: 20px; color: #94a3b8;">é»æ“Šé¸å–æ­·å²æ•¸æ“š CSV</label>
        <button onclick="runAll()">å•Ÿå‹• 500 æ¬¡æ”¶æ–‚åˆ†æ</button>
    </div>

    <div id="coldRankSection" class="card" style="display:none;">
        <h3>âš ï¸ ç›®å‰æ¥µå†·è™Ÿæ’è¡Œæ¦œ</h3>
        <div id="coldList" style="display: flex; justify-content: space-around; flex-wrap: wrap;"></div>
    </div>

    <div class="dashboard-grid">
        <div id="history" class="card"><h3>è¿‘æœŸé–‹çæ­·å²</h3></div>
        <div id="stats_table" class="card"><h3>ç­–ç•¥å›æ¸¬è¡¨ç¾</h3></div>
    </div>

    <div id="results" class="card">
        <h3>æ™ºèƒ½æ¨è–¦çµ„åˆ</h3>
        <div style="text-align: center; padding: 40px; opacity: 0.3;">ç­‰å¾…æ•¸æ“šåŸ·è¡Œ...</div>
    </div>

    <div class="card">
        <h3>è‡ªé¸è™Ÿç¢¼å‹ç‡é©—è­‰</h3>
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
            <input type="number" class="inline-input" id="userNum1" placeholder="01">
            <input type="number" class="inline-input" id="userNum2" placeholder="02">
            <input type="number" class="inline-input" id="userNum3" placeholder="03">
            <input type="number" class="inline-input" id="userNum4" placeholder="04">
            <input type="number" class="inline-input" id="userNum5" placeholder="05">
        </div>
        <button onclick="verifyUserPick()" style="background: transparent; border: 2px solid var(--accent); color: var(--accent);">é©—è­‰æ­·å²å‘½ä¸­æ½›åŠ›</button>
        <div id="userPickResult" style="margin-top:25px;"></div>
    </div>
</div>

<script>
let HIST_DATA = [];
const RULES = [
    { name: "ä¿å®ˆå‹", pool: "hot", desc: "é–å®šé«˜é »é‡è¤‡ç†±è™Ÿ", logic: "é »ç‡ 60% + é—œè¯ 30%" },
    { name: "å¹³è¡¡å‹", pool: "mix", desc: "å…¼é¡§éºæ¼å€¼èˆ‡ç†±åº¦", logic: "å¹³å‡åˆ†é…æ¬Šé‡" },
    { name: "æ¿€é€²å‹", pool: "corr", desc: "æ•æ‰ç‰ˆè·¯è½‰æŠ˜è·³è™Ÿ", logic: "å¤§è·¨åº¦é—œè¯çŸ©é™£" },
    { name: "åè½‰å‹", pool: "cold", desc: "å°ˆæ”»é•·æœŸæœªå‡ºå†·è™Ÿ", logic: "æ¥µè‡´éºæ¼è£œä½" }
];

async function runAll(){
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("è«‹å…ˆé¸å– CSV");
    HIST_DATA = parseCSV(await file.text());
    const omission = getOmissionMap(HIST_DATA);
    updateColdRankUI(omission);
    showHistory(HIST_DATA);
    renderResultsWithConvergence(HIST_DATA, omission);
}

function parseCSV(text){
    return text.trim().split("\n").slice(1).map(l => {
        const p = l.split(",");
        return {date: p[0], nums: p.slice(2, 7).map(n => parseInt(n)).sort((a,b)=>a-b)};
    }).filter(x => !isNaN(x.nums[0]));
}

function getOmissionMap(data) {
    const map = {}; for(let i=1; i<=39; i++) map[i] = 0;
    const lastIdx = {};
    data.forEach((d, idx) => d.nums.forEach(n => lastIdx[n] = idx));
    for(let i=1; i<=39; i++) map[i] = data.length - (lastIdx[i] ?? -1);
    return map;
}

function renderResultsWithConvergence(data, omission) {
    const resArea = document.getElementById("results");
    resArea.innerHTML = "";

    // åŸ·è¡Œ 500 æ¬¡æ”¶æ–‚åˆ†æ
    const freq = {};
    for(let i=0; i<500; i++) {
        RULES.forEach(r => {
            const pick = generateSmartPick(data, r, omission, 1);
            pick.forEach(n => freq[n] = (freq[n]||0) + 1);
        });
    }

    const resonantNums = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(i=>i[0]).sort((a,b)=>a-b);

    // æ¸²æŸ“æ ¸å¿ƒå…±é³´å¡ç‰‡
    const resonanceCard = document.createElement("div");
    resonanceCard.className = "card resonance-card";
    resonanceCard.innerHTML = `
        <h3 style="color:var(--gold)">ğŸ¯ æ ¸å¿ƒå…±é³´è™Ÿç¢¼ (500æ¬¡æ”¶æ–‚)</h3>
        <p style="font-size:0.75rem; opacity:0.8; margin-top:-10px">é€™æ˜¯å¤§æ•¸æ“šæ”¶æ–‚å¾Œçš„æœ€é«˜æ©Ÿç‡å…¬ç´„æ•¸</p>
        <div style="text-align:center; margin:15px 0">
            ${resonantNums.map(n => `<span class="ball" style="background:var(--gold); color:#000">${String(n).padStart(2,'0')}</span>`).join("")}
        </div>
    `;
    resArea.appendChild(resonanceCard);

    // æ¸²æŸ“å„ç­–ç•¥
    RULES.forEach((r, idx) => {
        const pick = generateSmartPick(data, r, omission, 100);
        const block = document.createElement("div");
        block.className = "strategy-block active";
        block.onclick = () => { const d = document.getElementById(`d-${idx}`); d.style.display = d.style.display==='block'?'none':'block'; };
        block.innerHTML = `
            <div style="display:flex; justify-content:space-between">
                <span style="color:var(--accent); font-weight:bold">${r.name} â–¾</span>
                <span class="rate-badge">ç©©å®šåº¦é«˜</span>
            </div>
            <div style="text-align:center; margin-top:10px">${pick.map(n => `<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</div>
            <div id="d-${idx}" class="logic-detail"><strong>é‚è¼¯ï¼š</strong>${r.desc}<br><strong>æ¬Šé‡ï¼š</strong>${r.logic}</div>`;
        resArea.appendChild(block);
    });
}

function generateSmartPick(data, rule, omission, sims) {
    const f = {}; data.forEach(d => d.nums.forEach(n => f[n] = (f[n]||0)+1));
    let candidates = [];
    for(let i=0; i<sims; i++) {
        let arr = Array.from({length:39}, (_, j) => j+1);
        arr.sort((a,b) => (rule.pool === 'cold' ? (omission[b]-omission[a]) : (f[b]-f[a])) + (Math.random()*12-6));
        candidates.push(arr.slice(0,5).sort((a,b)=>a-b));
    }
    return candidates[0]; 
}

function verifyUserPick() {
    if(!HIST_DATA.length) return alert("è«‹è¼‰å…¥æ•¸æ“š");
    const p = [1,2,3,4,5].map(i => parseInt(document.getElementById("userNum"+i).value)).filter(n => n>0);
    let h2=0, h3=0, h4=0;
    HIST_DATA.forEach(d => {
        const m = d.nums.filter(n => p.includes(n)).length;
        if(m===2) h2++; if(m===3) h3++; if(m===4) h4++;
    });
    document.getElementById("userPickResult").innerHTML = `äºŒæ˜Ÿ: ${h2} | ä¸‰æ˜Ÿ: ${h3} | å››æ˜Ÿ: ${h4}`;
}

function showHistory(data){
    document.getElementById("history").innerHTML = "<h3>è¿‘æœŸé–‹çæ­·å²</h3><table>" + 
    data.slice(-5).reverse().map(d => `<tr><td>${d.date.slice(5)}</td><td>${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td></tr>`).join("") + "</table>";
}

function updateColdRankUI(omission) {
    const sorted = Object.entries(omission).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById("coldRankSection").style.display = "block";
    document.getElementById("coldList").innerHTML = sorted.map(item => `<div style="text-align:center"><div class="ball" style="border:2px solid var(--error)">${String(item[0]).padStart(2,'0')}</div><div class="cold-tag">${item[1]}æœŸ</div></div>`).join("");
}
</script>
</body>
</html>
