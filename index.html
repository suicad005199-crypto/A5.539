<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 回測系統｜每期必出手版</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #999; padding: 4px 6px; text-align: center; }
th { background: #eee; }
.hit { color: red; font-weight: bold; }
.period { margin-top: 25px; }
</style>
</head>
<body>

<h2>539 回測系統（每期必出手）</h2>
<input type="file" id="csvFile" accept=".csv">
<br><button onclick="run()">執行回測</button>

<div id="summary"></div>
<div id="detail"></div>

<script>
function parseCSV(t){
  return t.trim().split("\n").slice(1).map(r=>{
    const p=r.split(",");
    return {date:p[0], nums:p.slice(1).map(Number)};
  });
}

function run(){
  const f=document.getElementById("csvFile").files[0];
  if(!f) return alert("請上傳 CSV");
  const r=new FileReader();
  r.onload=()=>{
    const d=parseCSV(r.result);
    let total=0, hit2=0, hit3=0, hit4=0;
    let detail="";

    for(let i=30;i<d.length;i++){
      total++;
      const hist=d.slice(0,i);
      const act=d[i];

      // === 計 Gap ===
      const gap={};
      for(let n=1;n<=39;n++) gap[n]=0;
      hist.forEach(dr=>{
        for(let n=1;n<=39;n++) gap[n]++;
        dr.nums.forEach(n=>gap[n]=0);
      });

      // === 計 熱度 ===
      const freq={};
      hist.slice(-10).forEach(dr=>{
        dr.nums.forEach(n=>freq[n]=(freq[n]||0)+1);
      });

      // === 每顆號碼評分 ===
      const score={};
      for(let n=1;n<=39;n++){
        let s=0;
        if(gap[n]>=15) s+=3;
        else if(gap[n]>=8) s+=2;
        else if(gap[n]>=3) s+=1;

        if(freq[n]>=4) s+=3;
        else if(freq[n]>=2) s+=2;
        else if(freq[n]>=1) s+=1;

        score[n]=s;
      }

      // === 取前12顆 ===
      const pool=Object.keys(score)
        .sort((a,b)=>score[b]-score[a])
        .slice(0,12).map(Number);

      // === 組合 ===
      const combos=[];
      for(let a=0;a<pool.length;a++)
      for(let b=a+1;b<pool.length;b++)
      for(let c=b+1;c<pool.length;c++)
      for(let e=c+1;e<pool.length;e++)
      for(let f=e+1;f<pool.length;f++){
        const p=[pool[a],pool[b],pool[c],pool[e],pool[f]];
        let odd=p.filter(n=>n%2).length;
        let ps=p.reduce((x,n)=>x+score[n],0);
        if(odd===2||odd===3) ps+=2;
        combos.push({p, ps});
      }

      combos.sort((x,y)=>y.ps-x.ps);
      const plays=combos.slice(0,10);

      let max=0, rows="";
      plays.forEach(c=>{
        let h=0;
        const cells=c.p.map(n=>{
          if(act.nums.includes(n)){h++; return `<span class="hit">${n}</span>`;}
          return n;
        });
        if(h>max) max=h;
        rows+=`<tr><td>${cells.join("</td><td>")}</td><td>${h}</td></tr>`;
      });

      if(max>=2) hit2++;
      if(max>=3) hit3++;
      if(max>=4) hit4++;

      detail+=`
        <div class="period">
          <b>${act.date}</b>｜開獎：${act.nums.join(", ")}
          <table>
            <tr><th colspan="5">出手牌</th><th>中</th></tr>
            ${rows}
          </table>
          本期最高命中：${max}
        </div>`;
    }

    document.getElementById("summary").innerHTML=`
      可回測期數：${total}<br>
      出手期數：${total}<br>
      出手期 ≥2：${(hit2/total*100).toFixed(1)}%<br>
      出手期 ≥3：${(hit3/total*100).toFixed(1)}%<br>
      出手期 ≥4：${(hit4/total*100).toFixed(1)}%
    `;
    document.getElementById("detail").innerHTML=detail;
  };
  r.readAsText(f);
}
</script>
</body>
</html>
