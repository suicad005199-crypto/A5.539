<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539 QUANT PRO</title>

<style>
body {
    background:#0f172a;
    color:#f1f5f9;
    font-family:"Microsoft JhengHei",sans-serif;
    padding:20px;
}
.card {
    background:#1e293b;
    padding:20px;
    border-radius:16px;
    margin-bottom:20px;
}
.ball {
    display:inline-block;
    width:36px;
    height:36px;
    line-height:36px;
    border-radius:50%;
    background:#334155;
    color:#38bdf8;
    margin:4px;
    font-weight:bold;
}
button {
    width:100%;
    padding:14px;
    background:#38bdf8;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>

<div class="card">
    <h2>539 CSV 載入</h2>
    <input type="file" id="csvFile" accept=".csv">
    <br><br>
    <button onclick="runAll()">啟動分析</button>
</div>

<div id="history" class="card">
    <h3>近期開獎歷史</h3>
</div>

<script>
let HIST_DATA = [];
let CORR_MATRIX = {};

/* ================= 主流程 ================= */
async function runAll(){
    const fileInput = document.getElementById("csvFile");
    if(!fileInput.files.length){
        alert("請先選取 CSV");
        return;
    }

    const text = await fileInput.files[0].text();
    HIST_DATA = parseCSV(text);

    if(HIST_DATA.length === 0){
        alert("CSV 解析失敗，請確認格式");
        console.error(text);
        return;
    }

    buildCorrelationMatrix(HIST_DATA);
    showHistory(HIST_DATA);

    console.log("成功載入期數:", HIST_DATA.length);
}

/* ================= CSV 解析（已修正完成） ================= */
function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    lines.shift(); // 移除標題列

    return lines.map(line=>{
        const p = line.split(",");
        if(p.length !== 6) return null;

        const nums = p.slice(1,6)
            .map(n=>parseInt(n.trim(),10))
            .filter(n=>!isNaN(n))
            .sort((a,b)=>a-b);

        if(nums.length !== 5) return null;

        return {
            date: p[0].trim(),
            nums
        };
    })
    .filter(Boolean)
    .sort((a,b)=> new Date(a.date) - new Date(b.date));
}

/* ================= 相關矩陣 ================= */
function buildCorrelationMatrix(data){
    CORR_MATRIX = {};
    for(let i=0;i<data.length-1;i++){
        const cur = data[i].nums;
        const next = data[i+1].nums;
        cur.forEach(c=>{
            if(!CORR_MATRIX[c]) CORR_MATRIX[c] = {};
            next.forEach(n=>{
                CORR_MATRIX[c][n] = (CORR_MATRIX[c][n]||0)+1;
            });
        });
    }
}

/* ================= 顯示歷史 ================= */
function showHistory(data){
    let html = "<table>";
    data.slice(-5).reverse().forEach(d=>{
        html += `
        <tr>
            <td style="opacity:.6">${d.date}</td>
            <td>
                ${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,"0")}</span>`).join("")}
            </td>
        </tr>`;
    });
    html += "</table>";

    document.getElementById("history").innerHTML =
        "<h3>近期開獎歷史</h3>" + html;
}
</script>

</body>
</html>
