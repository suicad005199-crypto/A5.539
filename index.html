<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 聯集 ≥2 覆蓋率回測</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
.good { background: #c8f7c5; font-weight: bold; }
</style>
</head>
<body>

<h2>539 聯集 ≥2 覆蓋率回測（6 / 8 / 10 / 12 組）</h2>

<input type="file" id="csvFile" accept=".csv">
<button onclick="run()">執行回測</button>

<div id="summary"></div>

<script>
function parseCSV(text) {
  return text.trim().split('\n').slice(1).map(l => {
    const p = l.split(',');
    return { date: p[0], nums: p.slice(1).map(Number) };
  });
}

function run() {
  const f = document.getElementById('csvFile').files[0];
  if (!f) return alert('請上傳 CSV');

  const r = new FileReader();
  r.onload = e => simulate(parseCSV(e.target.result));
  r.readAsText(f);
}

function simulate(data) {
  let total = data.length - 10;

  let hit6 = 0, hit8 = 0, hit10 = 0, hit12 = 0;

  for (let i = 10; i < data.length; i++) {
    const hist = data.slice(i - 10, i);
    const target = data[i].nums;

    // 穩定池：熱號 + 冷號
    const freq = {};
    hist.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));
    const hot = Object.keys(freq).filter(n => freq[n] >= 2).map(Number);

    const lastSeen = {};
    data.slice(0, i).forEach((d, idx) =>
      d.nums.forEach(n => lastSeen[n] = idx)
    );
    const cold = Object.keys(lastSeen)
      .filter(n => i - lastSeen[n] >= 12)
      .map(Number);

    const pool = [...new Set([...hot, ...cold])].filter(n => n >= 1 && n <= 39);

    // 固定生成 12 組（不隨機）
    let picks = [];
    for (let k = 0; k < pool.length && picks.length < 12; k++) {
      for (let j = k + 1; j < pool.length && picks.length < 12; j++) {
        for (let m = j + 1; m < pool.length && picks.length < 12; m++) {
          let c = [pool[k], pool[j], pool[m]];
          while (c.length < 5) {
            const n = pool[(c.length * 7 + k) % pool.length];
            if (!c.includes(n)) c.push(n);
          }
          const odd = c.filter(n => n % 2).length;
          const sum = c.reduce((a,b)=>a+b,0);
          if ((odd === 2 || odd === 3) && sum >= 70 && sum <= 115) {
            picks.push(c.sort((a,b)=>a-b));
          }
        }
      }
    }

    function unionHit(cnt) {
      for (let i = 0; i < cnt; i++) {
        if (!picks[i]) continue;
        let h = picks[i].filter(n => target.includes(n)).length;
        if (h >= 2) return true;
      }
      return false;
    }

    if (unionHit(6)) hit6++;
    if (unionHit(8)) hit8++;
    if (unionHit(10)) hit10++;
    if (unionHit(12)) hit12++;
  }

  document.getElementById('summary').innerHTML = `
  <h3>回測結果（${total} 期）</h3>
  <table>
    <tr>
      <th>出手組數</th>
      <th>聯集 ≥2 命中率</th>
    </tr>
    <tr><td>6 組</td><td>${(hit6/total*100).toFixed(1)}%</td></tr>
    <tr><td>8 組</td><td>${(hit8/total*100).toFixed(1)}%</td></tr>
    <tr class="good"><td>10 組</td><td>${(hit10/total*100).toFixed(1)}%</td></tr>
    <tr><td>12 組</td><td>${(hit12/total*100).toFixed(1)}%</td></tr>
  </table>
  `;
}
</script>

</body>
</html>
