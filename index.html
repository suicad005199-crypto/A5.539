<script>
/* =========================
   å…¨å±€è³‡æ–™
========================= */
let data = [];
let analysisCache = null;

/* =========================
   CSV è¼‰å…¥ï¼ˆåŸé‚è¼¯ä¿ç•™ï¼‰
========================= */
document.getElementById("csvInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    const lines = evt.target.result.trim().split(/\r?\n/);
    data = [];

    lines.slice(1).forEach(line => {
      const parts = line.split(",");
      if (parts.length >= 6) {
        const nums = parts.slice(1,6).map(n=>parseInt(n));
        if (nums.every(n=>n>=1 && n<=39)) {
          data.push({ date: parts[0], numbers: nums });
        }
      }
    });

    if (!data.length) {
      showStatus("csvInfo","CSV ç„¡æœ‰æ•ˆè³‡æ–™","error");
      return;
    }

    showStatus(
      "csvInfo",
      `å·²è¼‰å…¥ ${data.length} æœŸè³‡æ–™`,
      "success"
    );
    showBasicStats();
  };
  reader.readAsText(file);
});

/* =========================
   åŸºæœ¬çµ±è¨ˆ
========================= */
function showBasicStats() {
  const freq = {};
  const sums = [];

  data.forEach(d=>{
    d.numbers.forEach(n=>freq[n]=(freq[n]||0)+1);
    sums.push(d.numbers.reduce((a,b)=>a+b,0));
  });

  const avgSum = Math.round(sums.reduce((a,b)=>a+b,0)/sums.length);

  const sorted = [...Array(39)].map((_,i)=>i+1)
    .sort((a,b)=>(freq[b]||0)-(freq[a]||0));

  document.getElementById("basicStats").style.display="grid";
  document.getElementById("basicStats").innerHTML = `
    <div class="stat-item"><div class="stat-label">ç¸½æœŸæ•¸</div><div class="stat-value">${data.length}</div></div>
    <div class="stat-item"><div class="stat-label">ç†±é–€</div><div class="stat-value">${sorted.slice(0,3).join(",")}</div></div>
    <div class="stat-item"><div class="stat-label">å†·é–€</div><div class="stat-value">${sorted.slice(-3).join(",")}</div></div>
    <div class="stat-item"><div class="stat-label">å¹³å‡å’Œå€¼</div><div class="stat-value">${avgSum}</div></div>
  `;
}

/* =========================
   é€²éšåˆ†æï¼ˆå¿«å–ï¼‰
========================= */
function calculateAdvancedStats() {
  const freq = {};
  const lastSeen = {};
  const sums = [];
  const oddHist = [];

  data.forEach((d,idx)=>{
    d.numbers.forEach(n=>{
      freq[n]=(freq[n]||0)+1;
      lastSeen[n]=idx;
    });
    const s = d.numbers.reduce((a,b)=>a+b,0);
    sums.push(s);
    oddHist.push(d.numbers.filter(n=>n%2).length);
  });

  const avgSum = sums.reduce((a,b)=>a+b,0)/sums.length;
  const std = Math.sqrt(
    sums.reduce((a,s)=>a+(s-avgSum)**2,0)/sums.length
  );

  return {
    freq,
    lastSeen,
    total:data.length,
    sumAvg:avgSum,
    sumStd:std,
    avgOdd:Math.round(oddHist.reduce((a,b)=>a+b,0)/oddHist.length)
  };
}

/* =========================
   åŠ æ¬Šéš¨æ©Ÿå·¥å…·
========================= */
function weightedRandom(items) {
  const total = items.reduce((a,b)=>a+b.w,0);
  let r = Math.random()*total;
  for (let it of items) {
    if ((r-=it.w)<=0) return it.v;
  }
  return items[items.length-1].v;
}

/* =========================
   æ ¸å¿ƒï¼šæ¨¡æ“¬å‹é æ¸¬ç”Ÿæˆ
========================= */
function generatePredictionNumbers() {
  if (!analysisCache) analysisCache = calculateAdvancedStats();
  const {freq,lastSeen,total,sumAvg,sumStd,avgOdd} = analysisCache;

  /* ---- å»ºç«‹æ¬Šé‡æ±  ---- */
  const pool = [];
  for (let n=1;n<=39;n++) {
    const f = freq[n]||0;
    const days = total-(lastSeen[n]??0);

    // é »ç‡å£“ç¸® + æ™‚é–“è¡°æ¸›
    const freqW = Math.sqrt(f+1);
    let timeW = 1;
    if (days<=30) timeW=1;
    else if (days<=100) timeW=0.6;
    else timeW=0.3;

    // å°å¹…å™ªéŸ³
    const noise = 0.9 + Math.random()*0.2;

    pool.push({
      v:n,
      w:freqW*timeW*noise
    });
  }

  /* ---- é‡è¤‡æŠ½æ¨£ + è»Ÿç´„æŸ ---- */
  let attempt=0;
  while (attempt<500) {
    attempt++;
    const picked=new Set();
    while (picked.size<5) {
      picked.add(weightedRandom(pool));
    }
    const nums=[...picked].sort((a,b)=>a-b);

    const odd = nums.filter(n=>n%2).length;
    const sum = nums.reduce((a,b)=>a+b,0);
    const span = nums[4]-nums[0];

    let pass=true;

    // å¥‡å¶è»Ÿç´„æŸ
    if (Math.abs(odd-avgOdd)>1 && Math.random()<0.6) pass=false;

    // å’Œå€¼è»Ÿç´„æŸ
    if (Math.abs(sum-sumAvg)>2*sumStd && Math.random()<0.7) pass=false;

    // è·¨åº¦è»Ÿç´„æŸ
    if (span<15 && Math.random()<0.6) pass=false;

    if (pass) return nums;
  }

  // fallback
  return [...Array(39)].map((_,i)=>i+1)
    .sort(()=>Math.random()-0.5)
    .slice(0,5)
    .sort((a,b)=>a-b);
}

/* =========================
   UI å‘¼å«
========================= */
function generatePrediction() {
  if (!data.length) return alert("è«‹å…ˆè¼‰å…¥è³‡æ–™");
  showLoading("loadingC",true);
  setTimeout(()=>{
    const nums = generatePredictionNumbers();
    displayPrediction(nums);
    showLoading("loadingC",false);
  },600);
}

/* =========================
   é¡¯ç¤ºé æ¸¬ï¼ˆæ²¿ç”¨ä½ åŸæœ¬ï¼‰
========================= */
function displayPrediction(numbers) {
  const sum = numbers.reduce((a,b)=>a+b,0);
  const odd = numbers.filter(n=>n%2).length;
  const span = numbers[4]-numbers[0];

  document.getElementById("panelC").style.display="block";
  document.getElementById("panelC").innerHTML=`
    <div class="box">
      <div class="box-title">ğŸ¯ æ¨¡æ“¬é æ¸¬çµ„åˆ</div>
      <div class="numbers-grid">
        ${numbers.map(n=>`<div class="number-ball">${n}</div>`).join("")}
      </div>
      <div class="stats-row">
        <div class="stat-item"><div class="stat-label">å¥‡å¶</div><div class="stat-value">${odd}:${5-odd}</div></div>
        <div class="stat-item"><div class="stat-label">å’Œå€¼</div><div class="stat-value">${sum}</div></div>
        <div class="stat-item"><div class="stat-label">è·¨åº¦</div><div class="stat-value">${span}</div></div>
      </div>
      <div class="status success">æ­¤çµæœç‚ºã€Œæ­·å²åˆ†å¸ƒæ¨¡æ“¬è¼¸å‡ºã€ï¼Œéå–®é»é æ¸¬</div>
    </div>
  `;
}

/* =========================
   å°å·¥å…·
========================= */
function showStatus(id,msg,type="info"){
  document.getElementById(id).innerHTML=`<div class="status ${type}">${msg}</div>`;
}
function showLoading(id,show){
  document.getElementById(id).style.display=show?"block":"none";
}
</script>
