<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV æ™ºèƒ½æ•¸æ“šåˆ†æç³»çµ± v3</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --secondary: #3498db;
            --success: #27ae60;
            --bg: #f4f7f6;
        }

        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; width: 100%; max-width: 1200px; margin-left: auto; margin-right: auto; box-sizing: border-box; }
        .panel-title { margin-top: 0; color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; font-size: 1.2rem; margin-bottom: 15px; }

        /* é æ¸¬èˆ‡çµ±è¨ˆå¡ç‰‡ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-top: 4px solid var(--secondary); }
        .card h4 { margin: 0 0 10px 0; color: var(--primary); }
        .num-badge { display: inline-block; background: var(--primary); color: white; border-radius: 4px; padding: 4px 10px; margin: 3px; font-weight: bold; font-size: 0.9rem; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin: 2px; }
        .status-streak { background: #ffeaa7; color: #d35400; font-weight: bold; } /* é€£é–‹ */
        .status-miss { background: #dfe6e9; color: #636e72; } /* æœªé–‹ */

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { overflow-x: auto; max-height: 500px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #eee; text-align: center; padding: 8px; font-size: 13px; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        .hit { background: var(--accent); color: white; border-radius: 50%; display: inline-block; width: 22px; height: 22px; line-height: 22px; font-weight: bold; }

        /* æ”¶åˆé¢æ¿ */
        .accordion-header { cursor: pointer; background: #eee; padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; }
        .accordion-content { display: none; padding: 15px; border: 1px solid #eee; border-top: none; line-height: 1.6; }
    </style>
</head>
<body>

    <div class="panel">
        <h3 class="panel-title">1. æ•¸æ“šä¸Šå‚³</h3>
        <input type="file" id="csvFile" accept=".csv">
    </div>

    <div id="analysisSection" style="display:none;">
        <div class="panel">
            <h3 class="panel-title">2. æ™ºèƒ½é æ¸¬ä¸‹ä¸€æœŸ</h3>
            <div class="grid-container" id="predictionResults"></div>
        </div>

        <div class="panel">
            <h3 class="panel-title">3. è™Ÿç¢¼ç•¶å‰ç‹€æ…‹è¿½è¹¤ (é€£é–‹ / éºæ¼)</h3>
            <div id="statusTracker" style="display: flex; flex-wrap: wrap; gap: 8px;">
                </div>
        </div>
    </div>

    <div class="panel">
        <h3 class="panel-title">4. é€£è™Ÿåˆ†å¸ƒåœ– (æœ€æ–° 10 æœŸ)</h3>
        <div class="table-container">
            <table id="distributionTable">
                <thead><tr id="chartHeader"></tr></thead>
                <tbody id="chartBody"><tr><td colspan="40">è«‹ä¸Šå‚³è³‡æ–™ä»¥é€²è¡Œåˆ†æ...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div class="accordion-header" onclick="toggleAccordion()">
            <strong>ç­–ç•¥é‚è¼¯èˆ‡ç‹€æ…‹èªªæ˜ (é»æ“Šå±•é–‹)</strong>
            <span id="accIcon">â–¼</span>
        </div>
        <div id="accContent" class="accordion-content">
            <p><strong>â— é€£é–‹æœŸæ•¸ï¼š</strong> è©²è™Ÿç¢¼å¾æœ€æ–°ä¸€æœŸé–‹å§‹ï¼Œé€£çºŒå‡ºç¾çš„æ¬¡æ•¸ã€‚</p>
            <p><strong>â— æœªé–‹æœŸæ•¸ï¼š</strong> è©²è™Ÿç¢¼è‡³ä»Šå·²é€£çºŒå¹¾æœŸæ²’æœ‰å‡ºç¾ã€‚</p>
            <p><strong>â— é æ¸¬é‚è¼¯ï¼š</strong> ç¶œåˆæ­·å²ç†±é»ã€è¿‘æœŸé„°è¿‘è™Ÿç¢¼è¦å¾‹ã€ä»¥åŠå†·é–€è™Ÿå›æ­¸æ©Ÿç‡é€²è¡Œè¨ˆç®—ã€‚</p>
        </div>
    </div>

    <script>
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => processData(e.target.result);
            reader.readAsText(file);
        });

        function processData(csvText) {
            const rows = csvText.split('\n').map(r => r.split(',')).filter(r => r.length > 1 && r[0].trim());
            const sortedRows = rows; // å‡è¨­åŸå§‹è³‡æ–™æœ«ç«¯ç‚ºæœ€æ–°
            const latest10 = [...sortedRows].slice(-10).reverse();
            
            renderChart(latest10);
            renderStatusTracker(sortedRows);
            generatePredictions(sortedRows);
            document.getElementById('analysisSection').style.display = 'block';
        }

        function renderChart(data) {
            const header = document.getElementById('chartHeader');
            const body = document.getElementById('chartBody');
            header.innerHTML = '<th>æ—¥æœŸ</th>' + Array.from({length: 39}, (_, i) => `<th>${i+1}</th>`).join('');
            
            body.innerHTML = data.map(row => {
                const nums = row.slice(1).map(n => n.trim());
                let cells = `<td>${row[0]}</td>`;
                for (let i = 1; i <= 39; i++) {
                    cells += `<td>${nums.includes(i.toString()) ? `<span class="hit">${i}</span>` : ''}</td>`;
                }
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function renderStatusTracker(allRows) {
            const tracker = document.getElementById('statusTracker');
            const reversedRows = [...allRows].reverse(); // å¾æœ€æ–°å¾€å›æ‰¾
            let html = '';

            for (let i = 1; i <= 39; i++) {
                const numStr = i.toString();
                let streak = 0;
                let miss = 0;
                let foundLatest = false;

                // è¨ˆç®—ç‹€æ…‹
                for (let j = 0; j < reversedRows.length; j++) {
                    const rowNums = reversedRows[j].slice(1).map(n => n.trim());
                    const isPresent = rowNums.includes(numStr);

                    if (j === 0) foundLatest = isPresent;

                    if (foundLatest) {
                        if (isPresent) streak++; else break;
                    } else {
                        if (!isPresent) miss++; else break;
                    }
                }

                if (foundLatest) {
                    html += `<div class="status-tag status-streak">${i} è™Ÿ: é€£é–‹ ${streak} æœŸ</div>`;
                } else {
                    html += `<div class="status-tag status-miss">${i} è™Ÿ: æœªé–‹ ${miss} æœŸ</div>`;
                }
            }
            tracker.innerHTML = html;
        }

        function generatePredictions(allRows) {
            const container = document.getElementById('predictionResults');
            const allNums = allRows.flatMap(r => r.slice(1)).map(n => n.trim());
            const lastRowNums = allRows[allRows.length - 1].slice(1).map(n => parseInt(n.trim()));

            const freq = {};
            allNums.forEach(n => freq[n] = (freq[n] || 0) + 1);

            const hotNums = Object.keys(freq).sort((a,b) => freq[b] - freq[a]).slice(0, 6);
            const neighborNums = [...new Set(lastRowNums.flatMap(n => [n-1, n+1]))].filter(n => n > 0 && n <= 39).slice(0, 6);
            const coldNums = Array.from({length: 39}, (_, i) => (i+1).toString()).sort((a,b) => (freq[a]||0) - (freq[b]||0)).slice(0, 6);

            container.innerHTML = `
                <div class="card"><h4>ğŸ”¥ ç†±é–€æ©Ÿç‡</h4>${hotNums.map(n => `<span class="num-badge">${n}</span>`).join('')}</div>
                <div class="card"><h4>æ³¢å‹•é„°è¿‘</h4>${neighborNums.map(n => `<span class="num-badge">${n}</span>`).join('')}</div>
                <div class="card"><h4>â„ï¸ å†·é–€å›æ­¸</h4>${coldNums.map(n => `<span class="num-badge">${n}</span>`).join('')}</div>
            `;
        }

        function toggleAccordion() {
            const content = document.getElementById('accContent');
            const icon = document.getElementById('accIcon');
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            icon.innerText = isOpen ? 'â–¼' : 'â–²';
        }
    </script>
</body>
</html>
