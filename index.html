<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 聯集 ≥2 覆蓋率回測（穩定版）</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 12px; }
td, th { border: 1px solid #aaa; padding: 6px 10px; text-align: center; }
.good { background: #c8f7c5; font-weight: bold; }
</style>
</head>
<body>

<h2>539 聯集 ≥2 覆蓋率回測（6 / 8 / 10 / 12 組）</h2>

<input type="file" id="csvFile" accept=".csv">
<button onclick="run()">執行回測</button>

<div id="summary"></div>

<script>
function parseCSV(text) {
  return text.trim().split('\n').slice(1).map(l => {
    const p = l.split(',');
    return { date: p[0], nums: p.slice(1).map(Number) };
  });
}

function run() {
  const f = document.getElementById('csvFile').files[0];
  if (!f) return alert('請上傳 CSV');

  const r = new FileReader();
  r.onload = e => simulate(parseCSV(e.target.result));
  r.readAsText(f);
}

function simulate(data) {
  if (data.length < 20) {
    alert('資料期數不足（至少 20 期）');
    return;
  }

  const start = 10;
  const total = data.length - start;

  let hit6 = 0, hit8 = 0, hit10 = 0, hit12 = 0;

  for (let i = start; i < data.length; i++) {
    const hist = data.slice(i - 10, i);
    const target = data[i].nums;

    /* === 建立穩定 pool === */
    const freq = {};
    hist.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));
    const hot = Object.keys(freq).filter(n => freq[n] >= 2).map(Number);

    const lastSeen = {};
    data.slice(0, i).forEach((d, idx) =>
      d.nums.forEach(n => lastSeen[n] = idx)
    );
    const cold = Object.keys(lastSeen)
      .filter(n => i - lastSeen[n] >= 12)
      .map(Number);

    let pool = [...new Set([...hot, ...cold])].filter(n => n >= 1 && n <= 39);

    /* pool 不足補齊 */
    for (let n = 1; pool.length < 20 && n <= 39; n++) {
      if (!pool.includes(n)) pool.push(n);
    }

    /* === 固定生成 12 組 === */
    let picks = [];
    let idx = 0;
    while (picks.length < 12) {
      let c = [];
      for (let k = 0; k < pool.length && c.length < 5; k++) {
        const n = pool[(idx + k * 3) % pool.length];
        if (!c.includes(n)) c.push(n);
      }
      idx++;

      const odd = c.filter(n => n % 2).length;
      const sum = c.reduce((a,b)=>a+b,0);

      if ((odd === 2 || odd === 3) && sum >= 70 && sum <= 115) {
        picks.push(c.sort((a,b)=>a-b));
      }
    }

    function unionHit(cnt) {
      for (let i = 0; i < cnt; i++) {
        const h = picks[i].filter(n => target.includes(n)).length;
        if (h >= 2) return true;
      }
      return false;
    }

    if (unionHit(6)) hit6++;
    if (unionHit(8)) hit8++;
    if (unionHit(10)) hit10++;
    if (unionHit(12)) hit12++;
  }

  document.getElementById('summary').innerHTML = `
    <h3>回測結果（${total} 期）</h3>
    <table>
      <tr>
        <th>出手組數</th>
        <th>聯集 ≥2 命中率</th>
      </tr>
      <tr><td>6 組</td><td>${(hit6/total*100).toFixed(1)}%</td></tr>
      <tr><td>8 組</td><td>${(hit8/total*100).toFixed(1)}%</td></tr>
      <tr class="good"><td>10 組</td><td>${(hit10/total*100).toFixed(1)}%</td></tr>
      <tr><td>12 組</td><td>${(hit12/total*100).toFixed(1)}%</td></tr>
    </table>
  `;
}
</script>

</body>
</html>
