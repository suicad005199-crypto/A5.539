<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 Strategy Analyzer Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #020617; --card: #1e293b; --accent: #0ea5e9; --hot: #ef4444; --cold: #3b82f6; --gold: #fbbf24; }
        body { margin: 0; background: var(--bg); color: #e2e8f0; font-family: sans-serif; padding: 12px; }
        .layout { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; }
        .glass { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid #334155; }
        .full { grid-column: 1 / -1; }
        
        /* 混合圖表區 */
        .chart-container { position: relative; height: 260px; width: 100%; }

        /* 球盤強化 */
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; }
        .ball { 
            aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.05); position: relative;
        }
        .ball span { font-size: 16px; font-weight: bold; }
        .ball .count { font-size: 9px; margin-top: 2px; }
        .ball .gap { position: absolute; top: 4px; right: 4px; font-size: 8px; color: #94a3b8; }
        .ball.selected { outline: 3px solid var(--gold); transform: scale(0.95); }

        /* 策略面板 */
        .strategy-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 14px; }
        select, input { background: #0f172a; color: white; border: 1px solid #475569; padding: 5px; border-radius: 6px; }
        .warning { color: #f87171; font-size: 12px; display: none; margin-top: 5px; }

        .btn-action { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: white; }
        #log { margin-top: 15px; background: #000; padding: 12px; border-radius: 8px; font-family: monospace; color: #34d399; font-size: 13px; display: none; }
        
        @media (max-width: 768px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="glass full">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <h3 style="margin:0">趨勢版路 (和值+奇偶+大小)</h3>
            <input type="file" id="csv" onchange="process(this)">
        </div>
        <div class="chart-container">
            <canvas id="compChart"></canvas>
        </div>
    </div>

    <div class="glass">
        <div class="strategy-row">
            <b>號碼盤 (熱度/開出/漏期)</b>
            <span id="stat" style="font-size:12px; color:var(--gold)">未選號碼</span>
        </div>
        <div id="grid" class="ball-grid"></div>
    </div>

    <div class="glass">
        <h3>智慧過濾選號</h3>
        <div class="strategy-row"><span>奇偶要求 (奇:偶)</span><select id="s-oe"><option value="any">隨機</option><option value="3:2">3:2</option><option value="2:3">2:3</option></select></div>
        <div class="strategy-row"><span>大小要求 (大:小)</span><select id="s-bs"><option value="any">隨機</option><option value="3:2">3:2</option><option value="2:3">2:3</option></select></div>
        <div class="strategy-row"><span>連號限制</span><select id="s-con"><option value="any">不限</option><option value="none">排除連號</option><option value="must">必須連號</option></select></div>
        <div class="strategy-row"><span>和值區間</span><span><input type="number" id="s-min" value="80" style="width:50px">-<input type="number" id="s-max" value="120" style="width:50px"></span></div>
        <div class="strategy-row"><span>熱度權重</span><select id="s-w"><option value="mid">平衡</option><option value="hot">極熱追號</option><option value="cold">冷號埋伏</option></select></div>
        <div class="strategy-row"><span>生成組數</span><input type="number" id="s-cnt" value="1" min="1" max="10" style="width:50px"></div>
        
        <button class="btn-action" onclick="generate()">執行戰略選號</button>
        <div id="warn" class="warning">⚠️ 限制過嚴：嘗試 2000 次仍無符合組合，請放寬區間。</div>
        <div id="log"></div>
    </div>
</div>

<script>
    let raw = [], freq = {}, gap = {}, selected = new Set(), chart;

    function process(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(l => l.trim() !== "").slice(1);
            freq = {}; for(let i=1; i<=39; i++) gap[i] = lines.length;
            raw = lines.map((l, idx) => {
                const c = l.split(',');
                const nums = c.slice(1,6).map(Number).filter(n => n > 0);
                nums.forEach(n => {
                    freq[n] = (freq[n] || 0) + 1;
                    if(gap[n] > idx) gap[n] = idx;
                });
                return { 
                    date: c[0].slice(5), 
                    nums, 
                    sum: nums.reduce((a,b)=>a+b, 0),
                    odd: nums.filter(n=>n%2!==0).length,
                    big: nums.filter(n=>n>=20).length
                };
            }).filter(d => d.nums.length === 5).reverse();
            renderChart();
            renderGrid();
        };
        reader.readAsText(input.files[0]);
    }

    function renderChart() {
        if(chart) chart.destroy();
        const data = raw.slice(-20);
        chart = new Chart(document.getElementById('compChart'), {
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    { type: 'line', label: '和值', data: data.map(d => d.sum), borderColor: '#fbbf24', yAxisID: 'y' },
                    { type: 'bar', label: '奇數數', data: data.map(d => d.odd), backgroundColor: 'rgba(239, 68, 68, 0.5)', yAxisID: 'y1' },
                    { type: 'bar', label: '大號數', data: data.map(d => d.big), backgroundColor: 'rgba(14, 165, 233, 0.5)', yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { position: 'left', min: 40, max: 160, grid: { display: false } },
                    y1: { position: 'right', min: 0, max: 5, grid: { color: '#334155' } }
                },
                plugins: { legend: { labels: { color: '#fff', boxWidth: 12 } } }
            }
        });
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const maxF = Math.max(...Object.values(freq), 1);
        for(let i=1; i<=39; i++) {
            const f = freq[i]||0, g = gap[i]||0;
            const b = document.createElement('div');
            b.className = `ball ${selected.has(i) ? 'selected' : ''}`;
            const hue = 200 - (f/maxF * 200); // 熱紅冷藍
            b.style.background = `hsla(${hue}, 70%, 35%, 0.8)`;
            b.innerHTML = `<span class="gap">${g}期</span><span>${i.toString().padStart(2,'0')}</span><span class="count">${f}次</span>`;
            b.onclick = () => {
                if(selected.has(i)) selected.delete(i); else if(selected.size < 5) selected.add(i);
                updateStat(); renderGrid();
            };
            grid.appendChild(b);
        }
    }

    function updateStat() {
        const arr = Array.from(selected);
        const sum = arr.length ? arr.reduce((a,b)=>a+b) : 0;
        document.getElementById('stat').innerText = `已選 ${arr.length} | 總和: ${sum} | 均值: ${arr.length?(sum/arr.length).toFixed(1):0}`;
    }

    function generate() {
        const cnt = parseInt(document.getElementById('s-cnt').value);
        const results = [];
        let pool = [];
        for(let i=1; i<=39; i++) {
            let w = 1;
            const mode = document.getElementById('s-w').value;
            if(mode === 'hot') w += (freq[i]||0) * 2;
            if(mode === 'cold') w += Math.floor((gap[i]||0)/2);
            if(mode === 'mid') w += (freq[i]||0) + Math.floor((gap[i]||0)/4);
            for(let j=0; j<w; j++) pool.push(i);
        }

        let loop = 0; document.getElementById('warn').style.display = 'none';
        while(results.length < cnt && loop < 2000) {
            loop++;
            let temp = new Set();
            while(temp.size < 5) temp.add(pool[Math.floor(Math.random() * pool.length)]);
            let arr = Array.from(temp).sort((a,b)=>a-b);
            
            const sum = arr.reduce((a,b)=>a+b);
            const odd = arr.filter(n=>n%2!==0).length;
            const big = arr.filter(n=>n>=20).length;
            const hasCon = arr.some((n,i)=> n === arr[i-1]+1);

            if( (document.getElementById('s-oe').value === 'any' || document.getElementById('s-oe').value === `${odd}:${5-odd}`) &&
                (document.getElementById('s-bs').value === 'any' || document.getElementById('s-bs').value === `${big}:${5-big}`) &&
                (sum >= parseInt(document.getElementById('s-min').value) && sum <= parseInt(document.getElementById('s-max').value)) &&
                (document.getElementById('s-con').value === 'any' || (document.getElementById('s-con').value === 'must' ? hasCon : !hasCon)) ) {
                results.push(arr.map(n=>n.toString().padStart(2,'0')).join(' '));
            }
        }

        if(results.length < cnt) document.getElementById('warn').style.display = 'block';
        const log = document.getElementById('log'); log.style.display = 'block';
        log.innerText = `[策略選號結果]\n` + results.map((r,i)=>`#${i+1}: ${r}`).join('\n');
    }

    renderGrid();
</script>
</body>
</html>
